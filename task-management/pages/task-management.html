<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タスク管理 - 記帳依頼・タスク管理システム</title>
    <!-- Favicon with cache busting -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=1">

    <!-- 既存スタイルを継承 -->
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../../custom-dropdown.css">
    <link rel="stylesheet" href="../../toast.css">
    <!-- タスク管理専用スタイル -->
    <link rel="stylesheet" href="../css/task-styles.css">

    <!-- Preload resources -->
    <link rel="modulepreload" href="../../supabase-client.js" crossorigin>
    <link rel="modulepreload" href="../../utils.js" crossorigin>
    <link rel="modulepreload" href="../js/task-management.js" crossorigin>

    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 統一ナビゲーションタブ -->
        <div class="tab-navigation">
            <a href="../../analytics.html" class="nav-tab dashboard">
                📈 進捗ダッシュボード
            </a>
            <a href="../../performance.html" class="nav-tab performance">
                👥 担当者別進捗
            </a>
            <a href="task-management.html" class="nav-tab tasks active">
                📋 タスク管理
            </a>
            <a href="../../index.html" class="nav-tab settings">
                ⚙️ 設定画面
            </a>
        </div>

        <!-- ヘッダー & フィルターエリア -->
        <div class="analytics-filters" style="background: #ffb5b587; padding: 15px; border-radius: 8px; margin-bottom: 10px; overflow: visible; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);">
            <!-- タイトル行 + サマリー情報 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; position: relative; overflow: visible;">
                <!-- 左側：タイトル + ボタン -->
                <div style="display: flex; align-items: center; gap: 20px;">
                    <h1 style="margin: 0;">📋 タスク管理システム</h1>

                    <!-- アクションボタン -->
                    <div style="display: flex; gap: 10px;">
                        <button id="add-task-btn" class="btn btn-primary" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            ➕ 新規タスク
                        </button>
                        <button id="template-btn" class="btn btn-secondary" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            📝 テンプレート
                        </button>
                    </div>
                </div>

                <!-- 中央：コンパクトサマリー -->
                <div class="compact-summary" style="display: flex; gap: 8px; align-items: center; position: absolute; left: 50%; transform: translateX(-50%);">
                    <div class="summary-compact" style="background: #f8f9fa; border: 2px solid #dee2e6; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="total-tasks" style="font-weight: bold; font-size: 1.1rem; color: #007bff; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #6c757d; margin: 0;">総数</div>
                    </div>
                    <div class="summary-compact" style="background: #fff3cd; border: 2px solid #ffeaa7; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="pending-tasks" style="font-weight: bold; font-size: 1.1rem; color: #856404; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #856404; margin: 0;">依頼中</div>
                    </div>
                    <div class="summary-compact" style="background: #d1ecf1; border: 2px solid #bee5eb; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="working-tasks" style="font-weight: bold; font-size: 1.1rem; color: #0c5460; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #0c5460; margin: 0;">作業完了</div>
                    </div>
                    <div class="summary-compact" style="background: #d4edda; border: 2px solid #c3e6cb; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="completed-tasks" style="font-weight: bold; font-size: 1.1rem; color: #155724; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #155724; margin: 0;">確認完了</div>
                    </div>
                </div>

                <!-- 右側スペース -->
                <div style="min-width: 100px;"></div>
            </div>

            <!-- フィルター行 -->
            <div class="filter-row" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <!-- 表示切替 -->
                <div class="filter-group">
                    <label>表示:</label>
                    <div class="view-toggle" style="display: flex; gap: 5px;">
                        <button id="view-all" class="view-btn active" data-view="all">全体</button>
                        <button id="view-my" class="view-btn" data-view="my">自分</button>
                    </div>
                </div>

                <!-- ステータスフィルター -->
                <div class="filter-group">
                    <label for="status-filter">ステータス:</label>
                    <select id="status-filter" class="form-control" style="width: 120px;">
                        <option value="">全て</option>
                        <option value="依頼中">依頼中</option>
                        <option value="作業完了">作業完了</option>
                        <option value="確認完了">確認完了</option>
                    </select>
                </div>

                <!-- 受任者フィルター -->
                <div class="filter-group">
                    <label for="assignee-filter">受任者:</label>
                    <select id="assignee-filter" class="form-control" style="width: 120px;">
                        <option value="">全て</option>
                        <!-- JavaScript で動的に生成 -->
                    </select>
                </div>

                <!-- 事業者フィルター -->
                <div class="filter-group">
                    <label for="client-filter">事業者:</label>
                    <select id="client-filter" class="form-control" style="width: 120px;">
                        <option value="">全て</option>
                        <!-- JavaScript で動的に生成 -->
                    </select>
                </div>

                <!-- 検索 -->
                <div class="filter-group">
                    <label for="search-input">検索:</label>
                    <input id="search-input" type="text" class="form-control" placeholder="タスク名で検索" style="width: 150px;">
                </div>

                <!-- 表示形式切替 -->
                <div class="filter-group">
                    <label>表示形式:</label>
                    <div class="display-toggle" style="display: flex; gap: 5px;">
                        <button id="display-list" class="display-btn active" data-display="list">📋 リスト</button>
                        <button id="display-card" class="display-btn" data-display="card">📊 カード</button>
                        <button id="display-calendar" class="display-btn" data-display="calendar">📅 カレンダー</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- メインコンテンツ：左右分割レイアウト -->
        <div class="task-dashboard-container" style="display: flex; gap: 20px; min-height: 600px;">

            <!-- 左側パネル：全体タスク管理 (2/3) -->
            <div class="left-panel" style="flex: 2; min-width: 0;">
                <div class="panel-header" style="background: #f8f9fa; padding: 15px; border-radius: 8px 8px 0 0; border-bottom: 2px solid #dee2e6; margin-bottom: 0;border: groove #a5a0a045;">
                    <h3 style="margin: -8px; color: #495057; display: flex; align-items: center; gap: 10px;">
                        📋 全体タスク管理
                        <span id="total-task-count" style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0件</span>
                    </h3>
                </div>

                <!-- タスク表示エリア -->
                <div id="task-display-area" style="background: white; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px;">
                    <!-- リスト表示 -->
                    <div id="list-view" class="task-view active">
                        <div class="table-responsive" style="font-size: 13px;">
                            <table id="tasks-table" class="table table-hover" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 40px; text-align: center;" data-sort="priority">重要度</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 150px;" data-sort="client_name">事業者</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 120px;" data-sort="task_name">タスク名</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 170px;" data-sort="description">内容</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 30px; text-align: center;" data-sort="reference_url">参照</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="requester_name">依頼者</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="assignee_name">受任者</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="created_at">依頼日</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="due_date">期限日</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="work_date">予定日</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 50px;" data-sort="status">ステータス</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-tbody">
                                    <!-- JavaScript で動的に生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- カード表示 -->
                    <div id="card-view" class="task-view" style="display: none;">
                        <div id="kanban-board" class="kanban-container">
                            <div class="kanban-column" data-status="依頼中" style=" border-left: solid #ffd100;">
                                <h3>📝 依頼中</h3>
                                <div class="kanban-tasks" id="tasks-pending"></div>
                            </div>
                            <div class="kanban-column" data-status="作業完了" style=" border-left: solid #5299ff;">
                                <h3>⚙️ 作業完了</h3>
                                <div class="kanban-tasks" id="tasks-working"></div>
                            </div>
                            <div class="kanban-column" data-status="確認完了" style =" border-left: solid #00c92e;">
                                <h3>✅ 確認完了</h3>
                                <div class="kanban-tasks" id="tasks-completed"></div>
                            </div>
                        </div>
                    </div>

                    <!-- カレンダー表示 -->
                    <div id="calendar-view" class="task-view" style="display: none;">
                        <div id="task-calendar">
                            <!-- FullCalendar で実装予定 -->
                            <p style="text-align: center; padding: 50px;">カレンダー表示は今後実装予定です</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側パネル：マイタスク (1/3) -->
            <div class="right-panel" style="flex: 0.8; min-width: 300px;">
                <div class="panel-header" style="background: #e7f3ff; padding: 8px; border-radius: 8px 8px 0 0; border-bottom: 2px solid #007bff; margin-bottom: 0;border: groove #a5a0a045;">
                    <h3 style="margin: 0; color: #0056b3; display: flex; align-items: center; justify-content: flex-start;">
                        👤 マイタスク
                        <span id="my-task-count" style="background: #0056b3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0件</span>
                    </h3>
                </div>

                <!-- マイタスク表示エリア -->
                <div class="my-tasks-container" style="background: white; border: 1px solid #007bff; border-top: none; border-radius: 0 0 8px 8px; padding: 15px; max-height: 600px; overflow-y: auto;">

                    <!-- 受任タスク（自分が実行する） -->
                    <div class="my-assigned-tasks" style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 6px 0; color: #dc3545; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between;">
                            🎯 受任中のタスク
                            <span id="assigned-count" style="background: #dc3545; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.75rem;">0</span>
                        </h4>
                        <div id="assigned-task-list" class="compact-task-list">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </div>

                    <!-- 依頼タスク（自分が作成した） -->
                    <div class="my-requested-tasks" style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 6px 0; color: #28a745; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between;">
                            📤 依頼中のタスク
                            <span id="requested-count" style="background: #28a745; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.75rem;">0</span>
                        </h4>
                        <div id="requested-task-list" class="compact-task-list">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </div>

                    <!-- 区切り線 -->
                    <div style="border-top: 1px solid #dee2e6; margin: 15px 0;"></div>

                    <!-- 確認完了したタスク -->
                    <div class="my-completed-tasks">
                        <h4 style="margin: 0 0 6px 0; color: #6c757d; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between;">
                            ✅ 確認完了したタスク
                            <span id="completed-count" style="background: #6c757d; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.75rem;">0</span>
                        </h4>
                        <div id="completed-task-list" class="compact-task-list">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- テンプレート選択モーダル -->
    <div id="template-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>タスクテンプレート選択</h2>
                <span class="close" id="template-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p>テンプレートを選択して新規タスクを作成します。</p>
                <div id="template-list" class="template-list">
                    <!-- JavaScriptで動的に生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="template-cancel-btn" class="btn btn-secondary">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- タスク作成/編集モーダル -->
    <div id="task-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="modal-title">新規タスク作成</h2>
                <span class="close" id="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <!-- 基本情報セクション -->
                    <div class="modal-section">
                        <div class="section-title">基本情報</div>
                        <div class="compact-form-row">
                            <label for="task-name">タスク名 <span class="required">*</span>:</label>
                            <input type="text" id="task-name" name="task_name" class="form-control" required>
                        </div>
                        <div class="compact-form-row">
                            <label for="client-select">事業者 <span class="required">*</span>:</label>
                            <select id="client-select" name="client_id" class="form-control" required>
                                <option value="">選択してください</option>
                                <!-- JavaScript で動的に生成 -->
                            </select>
                        </div>
                        <div class="compact-form-row">
                            <label for="assignee-select">受任者 <span class="required">*</span>:</label>
                            <select id="assignee-select" name="assignee_id" class="form-control" required>
                                <option value="">選択してください</option>
                                <!-- JavaScript で動的に生成 -->
                            </select>
                        </div>
                    </div>

                    <!-- 詳細情報セクション -->
                    <div class="modal-section">
                        <div class="section-title">詳細情報</div>
                        <div class="compact-form-row">
                            <label for="priority-select">重要度:</label>
                            <select id="priority-select" name="priority" class="form-control">
                                <option value="1">⭐ 低</option>
                                <option value="2" selected>⭐⭐ 中</option>
                                <option value="3">⭐⭐⭐ 高</option>
                            </select>
                        </div>
                        <div class="compact-form-row">
                            <label for="estimated-hours">想定時間（時間）:</label>
                            <input type="number" id="estimated-hours" name="estimated_time_hours" class="form-control" step="0.5" min="0">
                        </div>
                        <div class="compact-form-row">
                            <label for="due-date">期限日:</label>
                            <input type="date" id="due-date" name="due_date" class="form-control">
                        </div>
                        <div class="compact-form-row">
                            <label for="work-date">作業予定日:</label>
                            <input type="date" id="work-date" name="work_date" class="form-control">
                        </div>
                        <div class="compact-form-row">
                            <label for="reference-url">参照URL:</label>
                            <input type="url" id="reference-url" name="reference_url" class="form-control" placeholder="https://example.com">
                        </div>
                    </div>

                    <!-- 作業内容セクション -->
                    <div class="modal-section">
                        <div class="section-title">作業内容</div>
                        <div class="content-form-group">
                            <label for="task-description">作業内容:</label>
                            <textarea id="task-description" name="description" class="form-control content-textarea" rows="4" placeholder="作業の詳細を記入してください。URLを含む場合は自動的にリンクが生成されます。"></textarea>
                            <div id="task-description-display" class="linked-text-display" style="display: none;"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <!-- 閲覧モード時のボタン -->
                <div id="view-mode-buttons" style="display: none;">
                    <button type="button" id="close-view-btn" class="btn btn-secondary">閉じる</button>
                    <button type="button" id="edit-mode-btn" class="btn btn-primary">編集</button>
                </div>

                <!-- 編集モード時のボタン -->
                <div id="edit-mode-buttons" style="display: none;">
                    <button type="button" id="delete-task-btn" class="btn btn-danger" style="margin-right: auto;">削除</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary">キャンセル</button>
                    <button type="button" id="save-task-btn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ローディング表示 -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../../supabase-client.js"></script>
    <script type="module" src="../../utils.js"></script>
    <script type="module" src="../js/task-management.js"></script>
</body>
</html>