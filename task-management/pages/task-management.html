<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タスク管理 - 記帳依頼・タスク管理システム</title>
    <!-- Favicon with cache busting -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=1">

    <!-- 既存スタイルを継承 -->
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../../custom-dropdown.css">
    <link rel="stylesheet" href="../../toast.css">
    <!-- タスク管理専用スタイル -->
    <link rel="stylesheet" href="../css/task-styles.css">

    <!-- Preload resources -->
    <link rel="modulepreload" href="../../supabase-client.js" crossorigin>
    <link rel="modulepreload" href="../../utils.js" crossorigin>
    <link rel="modulepreload" href="../js/task-management.js" crossorigin>

    <!-- SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Frappe Gantt for gantt chart -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js"></script>
</head>
<body>
    <div class="container">
        <!-- 統一ナビゲーションタブ -->
        <div class="tab-navigation">
            <a href="../../analytics.html" class="nav-tab dashboard">
                🏠 ホーム画面
            </a>
            <a href="../../performance.html" class="nav-tab performance">
                👥 担当者別進捗
            </a>
            <a href="task-management.html" class="nav-tab tasks active">
                📋 記帳依頼
            </a>
            <a href="../../index.html" class="nav-tab settings">
                ⚙️ 設定画面
            </a>
        </div>

        <!-- ヘッダー & フィルターエリア -->
        <div class="analytics-filters" style="background: #a2a2a287; padding: 15px; border-radius: 8px; margin-bottom: 10px; overflow: visible; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);">
            <!-- タイトル行 + サマリー情報 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; position: relative; overflow: visible;">
                <!-- 左側：タイトル + ボタン -->
                <div style="display: flex; align-items: center; gap: 20px;">
                    <h1 style="margin: 0;">📋 記帳依頼・タスク管理</h1>

                    <!-- アクションボタン -->
                    <div style="display: flex; gap: 10px;">
                        <button id="add-task-btn" class="btn btn-primary" style="background: #007bffc4; color: white; border: groove 1px #ffffff; padding: 14px 16px; border-radius: 4px; cursor: pointer;">
                            ➕ 新規タスク
                        </button>
                        <button id="template-btn" class="btn btn-secondary" style="background: #6c757d; color: white; border: groove 1px #ffffff; padding: 14px 16px; border-radius: 4px; cursor: pointer;">
                            📝 テンプレート
                        </button>
                    </div>
                </div>

                <!-- 中央：コンパクトサマリー -->
                <div class="compact-summary" style="display: none; gap: 8px; align-items: center; position: absolute; left: 50%; transform: translateX(-50%);">
                    <div class="summary-compact" style="background: #f8f9fa; border: 2px solid #dee2e6; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="total-tasks" style="font-weight: bold; font-size: 1.1rem; color: #007bff; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #6c757d; margin: 0;">総数</div>
                    </div>
                    <div class="summary-compact" style="background: #fff3cd; border: 2px solid #ffeaa7; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="pending-tasks" style="font-weight: bold; font-size: 1.1rem; color: #856404; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #856404; margin: 0;">依頼中</div>
                    </div>
                    <div class="summary-compact" style="background: #d1ecf1; border: 2px solid #bee5eb; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="working-tasks" style="font-weight: bold; font-size: 1.1rem; color: #0c5460; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #0c5460; margin: 0;">作業完了</div>
                    </div>
                    <div class="summary-compact" style="background: #d4edda; border: 2px solid #c3e6cb; padding: 6px 12px; border-radius: 6px; text-align: center; min-width: 70px;">
                        <div id="completed-tasks" style="font-weight: bold; font-size: 1.1rem; color: #155724; margin: 0;">0</div>
                        <div style="font-size: 0.7rem; color: #155724; margin: 0;">確認完了</div>
                    </div>
                </div>

                <!-- 右側スペース -->
                <div style="min-width: 100px;"></div>
            </div>

            <!-- フィルター行 -->
            <div class="filter-row" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <!-- ステータスフィルター -->
                <div class="filter-group">
                    <label for="status-filter">ステータス:</label>
                    <select id="status-filter" class="form-control" style="width: 120px;">
                        <option value="">全て</option>
                        <option value="予定未定">予定未定</option>
                        <option value="依頼中">依頼中</option>
                        <option value="作業完了">確認待ち</option>
                        <option value="確認完了">確認完了</option>
                    </select>
                </div>

                <!-- 事業者フィルター -->
                <div class="filter-group">
                    <label for="client-filter">事業者:</label>
                    <div class="searchable-select-wrapper" style="width: 180px;">
                        <input type="text" id="client-filter-search" class="form-control searchable-select-input" placeholder="事業者で絞り込み..." autocomplete="off" style="font-size: 0.85rem;">
                        <div class="searchable-select-arrow">▼</div>
                        <div id="client-filter-dropdown" class="searchable-select-dropdown" style="display: none;">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                        <select id="client-filter" style="display: none;">
                            <!-- 隠しselect（フィルター処理用） -->
                        </select>
                    </div>
                </div>

                <!-- 検索 -->
                <div class="filter-group">
                    <label for="search-input">検索:</label>
                    <input id="search-input" type="text" class="form-control" placeholder="タスク名で検索" style="width: 150px;">
                </div>

                <!-- フィルターリセット -->
                <div class="filter-group">
                    <button id="reset-filters-btn" class="modern-reset-btn">
                        <span class="reset-icon">🔄</span>
                        <span class="reset-text">リセット</span>
                    </button>
                </div>

                <!-- 表示形式切替 -->
                <div class="filter-group">
                    <label>表示形式:</label>
                    <div class="display-toggle" style="display: flex; gap: 5px;">
                        <button id="display-list" class="display-btn active" data-display="list">📋 リスト</button>
                        <button id="display-card" class="display-btn" data-display="card">📊 カード</button>
                        <button id="display-calendar" class="display-btn" data-display="calendar">📅 カレンダー</button>
                    </div>
                </div>

                <!-- 履歴閲覧システム -->
                <div class="filter-group">
                    <button id="history-toggle" class="history-toggle">
                        <span class="history-icon">📅</span>
                        <span class="history-text">履歴表示</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 履歴設定パネル -->
        <div id="history-panel" class="history-panel" style="display: none;">
            <div class="history-panel-content">
                <div class="history-controls">
                    <label>履歴期間:</label>
                    <select id="history-period-select" class="form-control">
                        <option value="current">現在のタスクのみ</option>
                        <option value="7days">過去7日間</option>
                        <option value="30days">過去30日間</option>
                        <option value="all">すべての履歴</option>
                    </select>

                    <div class="history-actions">
                        <button id="apply-history-filter" class="btn btn-primary btn-sm">適用</button>
                        <button id="close-history-panel" class="btn btn-secondary btn-sm">閉じる</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- メインコンテンツ：左右分割レイアウト -->
        <div class="task-dashboard-container" style="display: flex; gap: 20px; min-height: 600px; position: relative;">

            <!-- 担当者サイドバー（固定配置） -->
            <div class="assignee-sidebar" id="assignee-sidebar">
                <!-- JavaScript で動的に生成 -->
            </div>

            <!-- 左側パネル：全体タスク管理 (2/3) -->
            <div class="left-panel" style="flex: 2; min-width: 0; margin-left: 70px;">
                <div class="panel-header" style="background: #f8f9fa; padding: 15px; border-radius: 8px 8px 0 0; border-bottom: 2px solid #dee2e6; margin-bottom: 0;border: groove #a5a0a045;">
                    <h3 style="margin: -11px;color: #495057;display: flex;gap: 26px;margin-left: 0px;justify-content: center;">
                        📋 全体記帳依頼・タスク管理
                        <span id="total-task-count" style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0件</span>
                    </h3>
                </div>

                <!-- タスク表示エリア -->
                <div id="task-display-area" style="background: white; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 8px 8px;">
                    <!-- リスト表示 -->
                    <div id="list-view" class="task-view active">
                        <div class="table-responsive" style="font-size: 14px;">
                            <table id="tasks-table" class="table table-hover" style="margin-bottom: 0;">
                                <thead>
                                    <tr>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 40px; text-align: center;" data-sort="priority">重要度</th>
                                        <th style="cursor: pointer; padding: 4px 6px; min-width: 200px; max-width: 250px;" data-sort="client_name">事業者</th>
                                        <th style="cursor: pointer; padding: 4px 6px; min-width: 150px;" data-sort="task_name">タスク名</th>
                                        <th style="cursor: pointer; padding: 4px 6px; min-width: 180px; text-align: center;" data-sort="description">内容</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 30px; text-align: center;" data-sort="estimated_time_hours">時間</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 30px; text-align: center;" data-sort="reference_url">参照</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="requester_name">依頼者</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="assignee_name">受任者</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="created_at">依頼日</th>
                                        <th style="cursor: pointer; padding: 4px 4px; width: 55px;" data-sort="due_date">期限日</th>
                                        <th style="cursor: pointer; padding: 4px 6px; width: 45px;" data-sort="work_date">予定日</th>
                                        <th style="cursor: pointer; padding: 4px 11px; width: 50px;" data-sort="status">ステータス</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-tbody">
                                    <!-- JavaScript で動的に生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- カード表示 -->
                    <div id="card-view" class="task-view" style="display: none;">
                        <div id="kanban-board" class="kanban-container">
                            <div class="kanban-column" data-status="依頼中" style=" border-left: solid #ffd100;">
                                <h3>📝 依頼中</h3>
                                <div class="kanban-tasks" id="tasks-pending"></div>
                            </div>
                            <div class="kanban-column" data-status="作業完了" style=" border-left: solid #5299ff;">
                                <h3>✅ 確認待ち</h3>
                                <div class="kanban-tasks" id="tasks-working"></div>
                            </div>
                            <div class="kanban-column" data-status="確認完了" style =" border-left: solid #00c92e;">
                                <h3>☑️ 確認完了</h3>
                                <div class="kanban-tasks" id="tasks-completed"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ガントチャート表示 -->
                    <div id="calendar-view" class="task-view" style="display: none;">
                        <!-- ビュー切替ボタン -->
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                            <button id="gantt-add-holiday-btn" class="btn btn-sm" style="background: #28a745; color: white;">休日管理</button>
                            <span style="color: #6c757d; font-size: 12px;">※ガントチャートの日付をクリックして個人休暇を設定できます</span>
                        </div>

                        <!-- ガントチャート本体 -->
                        <div id="gantt-chart-container" style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #dee2e6; overflow-x: auto;">
                            <svg id="gantt-chart"></svg>
                        </div>

                        <!-- 依頼中タスク一覧（常時表示） -->
                        <div id="anytime-tasks-section"
                            data-status="依頼中"
                            ondragover="taskManager.handleSectionDragOver(event)"
                            ondragleave="taskManager.handleSectionDragLeave(event)"
                            ondrop="taskManager.handleSectionDrop(event)"
                            style="background: #fff9e6; border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #ffc107; transition: all 0.2s;">
                            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #856404;">📋 依頼中タスク</h4>
                            <div id="anytime-tasks-list" style="font-size: 13px; min-height: 50px;">
                                <!-- 依頼中タスク・予定未定タスクがここに表示されます -->
                            </div>
                        </div>

                        <!-- 確認待ちタスク（折りたたみ） -->
                        <div id="working-tasks-section"
                            data-status="作業完了"
                            ondragover="taskManager.handleSectionDragOver(event)"
                            ondragleave="taskManager.handleSectionDragLeave(event)"
                            ondrop="taskManager.handleSectionDrop(event)"
                            style="background: #ffe6e6; border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #dc3545; transition: all 0.2s;">
                            <h4 id="working-tasks-header" style="margin: 0; font-size: 14px; color: #721c24; cursor: pointer; user-select: none;">
                                ▼ 確認待ち (<span id="working-tasks-count">0</span>件)
                            </h4>
                            <div id="working-tasks-list" style="font-size: 13px; color: #721c24; margin-top: 10px; display: none; min-height: 50px;">
                                <!-- 確認待ちタスクがここに表示されます -->
                            </div>
                        </div>

                        <!-- 確認完了タスク（折りたたみ） -->
                        <div id="completed-tasks-section"
                            data-status="確認完了"
                            ondragover="taskManager.handleSectionDragOver(event)"
                            ondragleave="taskManager.handleSectionDragLeave(event)"
                            ondrop="taskManager.handleSectionDrop(event)"
                            style="background: #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #6c757d; transition: all 0.2s;">
                            <h4 id="completed-tasks-header" style="margin: 0; font-size: 14px; color: #495057; cursor: pointer; user-select: none;">
                                ▼ 確認完了 (<span id="completed-tasks-count">0</span>件)
                            </h4>
                            <div id="completed-tasks-list" style="font-size: 13px; color: #495057; margin-top: 10px; display: none; min-height: 50px;">
                                <!-- 確認完了タスクがここに表示されます -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側パネル：マイタスク (1/3) -->
            <div class="right-panel" style="flex: 0.8; min-width: 300px;">
                <div class="panel-header" style="background: #e7f3ff; padding: 8px; border-radius: 8px 8px 0 0; border-bottom: 2px solid #007bff; margin-bottom: 0;border: groove #a5a0a045;">
                    <h3 style="margin: 0;color: #0056b3;display: flex;align-items: center;justify-content: flex-start;width: 100%;gap: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            👤 マイタスク
                            <span id="my-task-count" style="background: #0056b3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">0件</span>
                        </div>
                        <div id="current-user-info" style="font-size: 18px;font-family: monospace;color: #6c757d;text-align: right;line-height: 1.2;display: flex;flex-direction: row;gap: 7px;align-items: flex-end;">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </h3>
                </div>

                <!-- マイタスク表示エリア -->
                <div class="my-tasks-container" style="background: white; border: 1px solid #007bff; border-top: none; border-radius: 0 0 8px 8px; padding: 15px; max-height: 600px; overflow-y: auto;">

                    <!-- 受任タスク（自分が実行する） -->
                    <div class="my-assigned-tasks" style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 6px 0; color: #dc3545; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                🎯 受任中のタスク
                                <span id="assigned-count" style="background: #dc3545; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.75rem;">0</span>
                            </div>
                            <div class="simple-view-toggle" style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #6c757d;">
                                <span id="simple-view-label">📋 詳細表示</span>
                                <label class="toggle-switch" style="position: relative; display: inline-block; width: 40px; height: 20px;">
                                    <input type="checkbox" id="simple-view-checkbox" style="opacity: 0; width: 0; height: 0;">
                                    <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px;">
                                        <span class="toggle-knob" style="position: absolute; content: ''; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                    </span>
                                </label>
                            </div>
                        </h4>
                        <div id="assigned-task-list" class="compact-task-list">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </div>

                    <!-- 依頼タスク（自分が作成した） -->
                    <div class="my-requested-tasks" style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 6px 0; color: #28a745; font-size: 0.9rem; display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                            📤 依頼中のタスク
                            <span id="requested-count" style="background: #28a745; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.75rem;">0</span>
                        </h4>
                        <div id="requested-task-list" class="compact-task-list">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </div>

                    <!-- 区切り線 -->
                    <div style="border-top: 1px solid #dee2e6; margin: 15px 0;"></div>

                    <!-- 確認完了したタスク -->
                    <div class="my-completed-tasks">
                        <h4 style="margin: 0 0 6px 0; color: #6c757d; font-size: 0.9rem; display: flex; align-items: center; justify-content: flex-start; gap: 10px;">
                            ☑️ 確認完了したタスク
                            <span id="completed-count" style="background: #6c757d; color: white; padding: 1px 6px; border-radius: 10px; font-size: 0.75rem;">0</span>
                        </h4>
                        <div id="completed-task-list" class="compact-task-list">
                            <!-- JavaScript で動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- テンプレート管理モーダル（全画面3分割） -->
    <div id="template-modal" class="modal template-fullscreen-modal" style="display: none;">
        <div class="template-modal-content">
            <!-- ヘッダー -->
            <div class="template-modal-header">
                <h2>📋 テンプレート管理システム</h2>
                <div class="template-header-controls">
                    <button id="template-help-btn" class="btn btn-info btn-sm" title="使い方">❓</button>
                    <span class="close" id="template-modal-close">&times;</span>
                </div>
            </div>

            <!-- メインコンテンツ：3分割レイアウト -->
            <div class="template-main-content">
                <!-- 左側：月次自動タスク作成 -->
                <div class="template-section template-section-recurring">
                    <div class="template-section-header">
                        <h3>🔄 月次自動タスク作成</h3>
                        <button class="template-add-btn" data-type="recurring">
                            ➕ 新規作成
                        </button>
                    </div>
                    <div class="template-section-description">
                        毎月自動で作成されるタスクを設定します。<br>
                        指定した日付の指定日数前に自動作成されます。
                        　　　　　　　【現在作成中】
                    </div>
                    <div class="template-list-container">
                        <div id="recurring-templates-list" class="template-list recurring-list">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>

                <!-- 中央：個別テンプレート -->
                <div class="template-section template-section-personal">
                    <div class="template-section-header">
                        <h3>👤 個別テンプレート</h3>
                        <button class="template-add-btn" data-type="personal">
                            ➕ 新規作成
                        </button>
                    </div>
                    <div class="template-section-description">
                        あなた専用のテンプレートです。<br>
                        よく使用するタスクをテンプレート化できます。
                    </div>
                    <div class="template-list-container">
                        <div id="personal-templates-list" class="template-list personal-list">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>

                <!-- 右側：共有テンプレート -->
                <div class="template-section template-section-global">
                    <div class="template-section-header">
                        <h3>🌐 共有テンプレート</h3>
                        <button class="template-add-btn" data-type="global">
                            ➕ 新規作成
                        </button>
                    </div>
                    <div class="template-section-description">
                        全員が使用できる共通テンプレートです。<br>
                        標準的な作業をテンプレート化できます。
                    </div>
                    <div class="template-list-container">
                        <div id="global-templates-list" class="template-list global-list">
                            <!-- JavaScriptで動的に生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- フッター -->
            <div class="template-modal-footer">
                <div class="template-footer-info">
                    <span id="template-count-info">📊 総テンプレート数: 0</span>
                </div>
                <div class="template-footer-buttons">
                    <button type="button" id="template-cancel-btn" class="btn btn-secondary">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- テンプレート作成・編集モーダル -->
    <div id="template-edit-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 465px;">
            <div class="modal-header">
                <h2 id="template-edit-title">新規テンプレート作成</h2>
                <span class="close" id="template-edit-close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="template-edit-form">
                    <!-- テンプレートタイプ表示 -->
                    <div class="template-type-indicator" id="template-type-indicator">
                        <span id="template-type-text">📋 個別テンプレート</span>
                    </div>

                    <!-- 基本情報セクション -->
                    <div class="modal-section" id="template-basic-section">
                        <div class="section-title">基本情報</div>
                        <div class="compact-form-row">
                            <label for="template-name-input">テンプレート名 <span class="required">*</span>:</label>
                            <input type="text" id="template-name-input" name="template_name" class="form-control" required>
                        </div>
                        <div class="compact-form-row">
                            <label for="template-task-name">タスク名 <span class="required">*</span>:</label>
                            <input type="text" id="template-task-name" name="task_name" class="form-control" required>
                        </div>
                        <div class="compact-form-row">
                            <label for="template-priority">重要度:</label>
                            <select id="template-priority" name="priority" class="form-control">
                                <option value="1" selected>⭐ 通常</option>
                                <option value="2">⭐⭐ 急ぎ</option>
                                <option value="3">⭐⭐⭐ 緊急</option>
                            </select>
                        </div>
                        <div class="compact-form-row">
                            <label for="template-estimated-hours">想定時間（時間）:</label>
                            <input type="number" id="template-estimated-hours" name="estimated_time_hours" class="form-control" step="0.5" min="0">
                        </div>
                        <div class="compact-form-row">
                            <label for="template-client-search">事業者名:</label>
                            <div class="searchable-select-wrapper">
                                <input type="text" id="template-client-search" class="form-control searchable-select-input" placeholder="事業者名を入力または選択（全角半角対応）..." autocomplete="off" style="min-width: 254px;">
                                <div class="searchable-select-arrow">▼</div>
                                <div id="template-client-dropdown" class="searchable-select-dropdown" style="display: none;">
                                    <!-- JavaScript で動的に生成 -->
                                </div>
                                <select id="template-client-select" name="client_id" style="display: none;">
                                    <!-- 隠しselect（フォーム送信用） -->
                                </select>
                            </div>
                        </div>
                        <div class="compact-form-row">
                            <label for="template-reference-url">参照URL:</label>
                            <input type="url" id="template-reference-url" name="reference_url" class="form-control" placeholder="https://example.com">
                        </div>
                        <div class="compact-form-row" id="template-default-assignee-row">
                            <label for="template-default-assignee-general">既定の受任者:</label>
                            <select id="template-default-assignee-general" name="default_assignee_id" class="form-control">
                                <option value="">選択してください</option>
                                <!-- JavaScriptで動的に生成 -->
                            </select>
                        </div>
                    </div>

                    <!-- 月次自動タスク専用設定 -->
                    <div class="modal-section" id="recurring-settings" style="display: none;">
                        <div class="section-title">🔄 自動作成設定</div>
                        <div class="compact-form-row">
                            <label for="template-due-day">毎月の期限日:</label>
                            <select id="template-due-day" name="due_day" class="form-control">
                                <option value="">選択してください</option>
                                <option value="1">1日</option>
                                <option value="5">5日</option>
                                <option value="10">10日</option>
                                <option value="15">15日</option>
                                <option value="20">20日</option>
                                <option value="25">25日</option>
                                <option value="last">月末</option>
                            </select>
                        </div>
                        <div class="compact-form-row">
                            <label for="template-create-days-before">何日前に作成:</label>
                            <select id="template-create-days-before" name="create_days_before" class="form-control">
                                <option value="1">1日前</option>
                                <option value="3">3日前</option>
                                <option value="5">5日前</option>
                                <option value="7">7日前</option>
                                <option value="10" selected>10日前</option>
                                <option value="14">14日前</option>
                            </select>
                        </div>
                        <div class="compact-form-row">
                            <label for="template-default-assignee">受任者:</label>
                            <select id="template-default-assignee" name="default_assignee_id" class="form-control">
                                <option value="">選択してください</option>
                                <!-- JavaScriptで動的に生成 -->
                            </select>
                        </div>
                    </div>

                    <!-- 作業内容セクション -->
                    <div class="modal-section" id="template-description-section">
                        <div class="section-title">作業内容</div>
                        <div class="content-form-group">
                            <textarea id="template-description" name="description" class="form-control content-textarea" rows="4" placeholder="作業の詳細を記入してください。URLを含む場合は自動的にリンクが生成されます。"></textarea>
                        </div>
                    </div>

                    <!-- お気に入り設定 -->
                    <div class="modal-section">
                        <div class="section-title">表示設定</div>
                        <div class="compact-form-row">
                            <label class="checkbox-label" style="min-width: 179px;">
                                <input type="checkbox" id="template-is-favorite" name="is_favorite">
                                ⭐ お気に入り登録
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <!-- 閲覧モード時のボタン -->
                <div id="template-view-mode-buttons" style="display: flex; gap: 10px;">
                    <button type="button" id="template-close-view-btn" class="btn btn-secondary">閉じる</button>
                    <button type="button" id="template-edit-mode-btn" class="btn btn-primary">編集</button>
                    <button type="button" id="template-use-btn" class="btn btn-success">このテンプレートを使用</button>
                </div>

                <!-- 編集モード時のボタン -->
                <div id="template-edit-mode-buttons" style="display: flex; gap: 10px;">
                    <button type="button" id="template-delete-btn" class="btn btn-danger">削除</button>
                    <button type="button" id="template-cancel-edit-btn" class="btn btn-secondary">キャンセル</button>
                    <button type="button" id="template-save-btn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- タスク作成/編集モーダル -->
    <div id="task-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; margin-top:-150px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 id="modal-title">新規タスク作成</h2>
                <div id="task-detail-info" style="display: flex; align-items: center; gap: 15px; margin-right: 20px;">
                    <div id="requester-info" style="display: none; font-size: 0.9rem; color: #495057;">
                        <span style="font-weight: 600;">依頼者:</span>
                        <span id="requester-name">-</span>
                    </div>
                    <div id="status-button-container" style="display: none;">
                        <!-- ステータスボタンがここに動的に追加される -->
                    </div>
                </div>
                <span class="close" id="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <!-- 基本情報セクション -->
                    <div class="modal-section">
                        <div class="section-title">基本情報</div>
                        <div class="compact-form-row">
                            <label for="task-name">タスク名 <span class="required">*</span>:</label>
                            <input type="text" id="task-name" name="task_name" class="form-control" required>
                        </div>
                        <div class="compact-form-row">
                            <label for="client-select">事業者 <span class="required">*</span>:</label>
                            <div class="searchable-select-wrapper" style="max-width: 265px;">
                                <input type="text" id="client-search" class="form-control searchable-select-input" placeholder="事業者名を入力または選択（全角半角対応）..." autocomplete="off" style="min-width: -webkit-fill-available;">
                                <div class="searchable-select-arrow">▼</div>
                                <div id="client-dropdown" class="searchable-select-dropdown" style="display: none;">
                                    <!-- JavaScript で動的に生成 -->
                                </div>
                                <select id="client-select" name="client_id" style="display: none;" required>
                                    <!-- 隠しselect（フォーム送信用） -->
                                </select>
                            </div>
                        </div>
                        <div class="compact-form-row">
                            <label for="assignee-select">受任者 <span class="required">*</span>:</label>
                            <select id="assignee-select" name="assignee_id" class="form-control" required>
                                <option value="">選択してください</option>
                                <!-- JavaScript で動的に生成 -->
                            </select>
                        </div>
                    </div>

                    <!-- 詳細情報セクション -->
                    <div class="modal-section">
                        <div class="section-title">詳細情報</div>
                        <div class="compact-form-row">
                            <label for="priority-select">重要度:</label>
                            <select id="priority-select" name="priority" class="form-control">
                                <option value="1" selected>⭐ 通常</option>
                                <option value="2">⭐⭐ 急ぎ</option>
                                <option value="3">⭐⭐⭐ 緊急</option>
                            </select>
                        </div>
                        <div class="compact-form-row">
                            <label for="estimated-hours">想定時間（時間）:</label>
                            <input type="number" id="estimated-hours" name="estimated_time_hours" class="form-control" step="0.5" min="0">
                        </div>
                        <div class="compact-form-row">
                            <label for="due-date">期限日:</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="date" id="due-date" name="due_date" class="form-control" style="flex: 1;">
                                <label style="display: flex; align-items: center; gap: 5px; margin: 0; white-space: nowrap; cursor: pointer;">
                                    <input type="checkbox" id="is-anytime" name="is_anytime" style="width: auto; margin: 0; cursor: pointer;">
                                    <span>随時</span>
                                </label>
                            </div>
                        </div>
                        <div class="compact-form-row">
                            <label for="work-date">作業予定日:</label>
                            <input type="date" id="work-date" name="work_date" class="form-control">
                        </div>
                        <div class="compact-form-row">
                            <label for="reference-url">参照URL:</label>
                            <div style="flex: 1; position: relative;">
                                <input type="url" id="reference-url" name="reference_url" class="form-control" placeholder="URLを入力してください">
                                <div id="reference-url-display" class="linked-text-display" style="display: none;min-height: 20px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 作業内容セクション -->
                    <div class="modal-section">
                        <div class="section-title">作業内容</div>
                        <div class="content-form-group">
                            <textarea id="task-description" name="description" class="form-control content-textarea" rows="4" placeholder="作業の詳細を記入してください。URLを含む場合は自動的にリンクが生成されます。"></textarea>
                            <div id="task-description-display" class="linked-text-display" style="display: none;"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <!-- 閲覧モード時のボタン -->
                <div id="view-mode-buttons" style="display: flex;gap: inherit;">
                    <button type="button" id="close-view-btn" class="btn btn-secondary" style="margin-right: 0px;display: inline-block;background-color: rgb(209 209 209 / 66%);color: rgb(99 99 99);border-radius: 5px;font-size: 20px;">閉じる</button>
                    <button type="button" id="edit-mode-btn" class="btn btn-primary" style="margin-right: 0px;display: inline-block;background-color: rgb(209 209 209 / 66%);color: rgb(99 99 99);border-radius: 5px;font-size: 20px;">編集</button>
                </div>

                <!-- 編集モード時のボタン -->
                <div id="edit-mode-buttons" style="display: flex;gap: inherit;">
                    <button type="button" id="delete-task-btn" class="btn btn-danger" style="margin-right: 31px;display: inline-block;background-color: #ff3434cc;color: #ffffff;border-radius: 5px;font-size: 20px;">削除</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="margin-right: 0px;display: inline-block;background-color: rgb(209 209 209 / 66%);color: rgb(99 99 99);border-radius: 5px;font-size: 20px;">キャンセル</button>
                    <button type="button" id="save-task-btn" class="btn btn-primary" style="margin-right: 0px;display: inline-block;background-color: rgb(209 209 209 / 66%);color: rgb(99 99 99);border-radius: 5px;font-size: 20px;">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ローディング表示 -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- 休日管理モーダル -->
    <div id="holiday-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>休日管理</h2>
                <span class="close" id="holiday-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- タブ切り替え -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #dee2e6;">
                    <button id="holiday-tab-company" class="btn btn-sm" style="padding: 8px 16px; border-bottom: 3px solid #007bff; background: transparent; color: #007bff;">会社休日</button>
                    <button id="holiday-tab-csv" class="btn btn-sm" style="padding: 8px 16px; background: transparent; color: #6c757d;">CSV入出力</button>
                </div>

                <!-- 会社休日タブ -->
                <div id="holiday-panel-company">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0;">会社休日を追加</h4>
                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">日付:</label>
                                <input type="date" id="company-holiday-date" class="form-control">
                            </div>
                            <div style="flex: 2;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">名称:</label>
                                <input type="text" id="company-holiday-name" class="form-control" placeholder="例: 夏季休業">
                            </div>
                            <button id="add-company-holiday-btn" class="btn" style="background: #28a745; color: white;">追加</button>
                        </div>
                    </div>

                    <h4>登録済み会社休日</h4>
                    <div id="company-holidays-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- 会社休日リストがここに表示されます -->
                    </div>
                </div>

                <!-- CSV入出力タブ -->
                <div id="holiday-panel-csv" style="display: none;">
                    <!-- CSV形式説明 -->
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h4 style="margin-top: 0;">💡 CSV形式について</h4>
                        <p style="margin: 5px 0; font-size: 14px;">休日データをCSV形式でインポート・エクスポートできます。</p>
                        <p style="margin: 5px 0; font-size: 13px; color: #555;">
                            <strong>形式:</strong> <code>id,日付,名称,種類</code><br>
                            <strong>種類:</strong> <code>national</code>(祝日), <code>company</code>(会社休日), <code>custom</code>(カスタム)<br>
                            <strong>例:</strong> <code>123,2025-12-30,年末休業,company</code>
                        </p>
                        <p style="margin: 10px 0 5px 0; font-size: 12px; color: #856404; background: #fff3cd; padding: 8px; border-radius: 4px; border-left: 3px solid #ffc107;">
                            <strong>⚠️ 重要:</strong> エクスポートしたCSVを編集してインポートすると、CSVの内容が正として扱われます。<br>
                            • 日付を変更した場合、古い日付のデータは自動的に削除されます<br>
                            • CSVから行を削除した場合、その休日も削除されます<br>
                            • 新しい行を追加した場合（ID列を空にする）、新規休日として登録されます
                        </p>
                    </div>

                    <!-- エクスポート -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0;">📤 エクスポート</h4>
                        <p style="font-size: 14px; color: #555; margin-bottom: 10px;">登録済みの休日データをCSVファイルとしてダウンロードします。</p>
                        <div style="display: flex; gap: 10px;">
                            <button id="export-holidays-csv-btn" class="btn" style="background: #17a2b8; color: white;">全休日データをエクスポート</button>
                        </div>
                    </div>

                    <!-- インポート -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0;">📥 インポート</h4>
                        <p style="font-size: 14px; color: #555; margin-bottom: 10px;">CSVファイルから休日データを一括登録します。</p>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="file" id="import-holidays-csv-file" accept=".csv" class="form-control" style="flex: 1;">
                            <button id="import-holidays-csv-btn" class="btn" style="background: #28a745; color: white;">インポート</button>
                        </div>
                        <p style="font-size: 12px; color: #999; margin-top: 8px;">※既存データとの重複（同じ日付）がある場合、新しいデータで上書きされます。</p>
                    </div>

                    <!-- インポート結果表示 -->
                    <div id="csv-import-result" style="display: none; background: #d4edda; border: 1px solid #c3e6cb; padding: 12px; border-radius: 5px; margin-top: 15px;">
                        <strong style="color: #155724;">✅ インポート成功</strong>
                        <p id="csv-import-result-text" style="margin: 5px 0 0 0; font-size: 14px; color: #155724;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../../supabase-client.js"></script>
    <script type="module" src="../../utils.js"></script>
    <script type="module" src="../js/task-management.js"></script>
</body>
</html>