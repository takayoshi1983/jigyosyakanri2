# 記帳依頼・タスク管理表アプリ 最終版実装計画書（統合版）

## プロジェクト概要

### アプリケーション名
「記帳依頼・タスク管理表アプリ」- 税理士事務所専用タスク管理システム

### 開発方針【統合アプローチ採用】
- **既存アプリへの機能統合**として実装
- 既存「事業者管理アプリ」の全リソース（DB・認証・UI）を完全活用
- `clients`・`staffs`テーブルをマスターデータとして参照
- 既存のナビゲーション・スタイルシステムに自然に統合

## 技術スタック

### フロントエンド
- **HTML/CSS/JavaScript（Vanilla JS）**
- **スタイル統一**：既存アプリのCSS変数・コンポーネントを活用
- **レスポンシブ対応**：モバイルファーストデザイン

### バックエンド・データベース
- **Supabase**：既存プロジェクト（https://ocfljsoxxgmnzqlquchx.supabase.co）を活用
- **認証**：Google OAuth 2.0（既存認証を共有）
- **データベース**：PostgreSQL with RLS

### デプロイ
- **Vercel**：既存アプリと同一プラットフォーム

## データベース設計

### 新規テーブル（3つ）

#### 1. tasks テーブル
```sql
CREATE TABLE tasks (
    id BIGSERIAL PRIMARY KEY,
    client_id BIGINT REFERENCES clients(id),
    assignee_id BIGINT REFERENCES staffs(id),
    requester_id BIGINT REFERENCES staffs(id),
    task_name TEXT NOT NULL,
    description TEXT,
    reference_url TEXT,
    due_date DATE,
    estimated_time_hours NUMERIC(5,2),
    completed_at TIMESTAMPTZ,
    confirmed_at TIMESTAMPTZ,
    status TEXT DEFAULT '依頼中' CHECK (status IN ('依頼中', '作業完了', '確認完了')),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 2. task_templates テーブル
```sql
CREATE TABLE task_templates (
    id BIGSERIAL PRIMARY KEY,
    template_name TEXT NOT NULL,
    task_name TEXT,
    description TEXT,
    estimated_time_hours NUMERIC(5,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 3. recurring_tasks テーブル
```sql
CREATE TABLE recurring_tasks (
    id BIGSERIAL PRIMARY KEY,
    template_id BIGINT REFERENCES task_templates(id),
    client_id BIGINT REFERENCES clients(id),
    assignee_id BIGINT REFERENCES staffs(id),
    frequency_type TEXT CHECK (frequency_type IN ('monthly', 'weekly', 'daily')),
    frequency_day INTEGER,
    is_active BOOLEAN DEFAULT TRUE,
    next_run_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### RLS（Row Level Security）設定
```sql
-- 全テーブルでRLS有効化
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE task_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE recurring_tasks ENABLE ROW LEVEL SECURITY;

-- 基本ポリシー（認証済みユーザーのみアクセス可能）
CREATE POLICY "Authenticated users can access" ON tasks
    FOR ALL USING (auth.uid() IS NOT NULL);
```

## 段階的実装計画

### ステップ1: 基盤構築（所要時間: 3-4時間）

#### 1.1 既存プロジェクトへの統合準備
- [ ] 既存プロジェクトに新ファイル追加
  ```
  既存プロジェクト/
  ├── analytics.html       # 既存: メイン画面
  ├── task-management.html # 新規: タスク管理画面
  ├── task-detail.html     # 新規: タスク詳細画面
  ├── style.css           # 既存: 共通スタイル（継承）
  ├── task-styles.css     # 新規: タスク専用スタイル
  ├── supabase-client.js  # 既存: 共有DB接続
  ├── task-management.js  # 新規: タスク機能
  └── task-detail.js      # 新規: 詳細画面機能
  ```

#### 1.2 Supabase接続・認証確認
- [ ] 既存プロジェクトへの接続設定
- [ ] Google OAuth認証の動作確認
- [ ] `clients`・`staffs`テーブルからのデータ取得テスト

#### 1.3 データベーステーブル作成
- [ ] `tasks`テーブル作成・RLS設定
- [ ] `task_templates`テーブル作成・RLS設定
- [ ] `recurring_tasks`テーブル作成・RLS設定

### ステップ2: コア機能実装（所要時間: 5-6時間）

#### 2.1 タスク一覧表示機能
- [ ] **基本一覧**：タスクデータの表形式表示
- [ ] **フィルター機能**：担当者・ステータス・期限での絞り込み
- [ ] **検索機能**：タスク名・事業者名での検索
- [ ] **ソート機能**：期限・作成日・ステータス順でソート

#### 2.2 タスク登録機能
- [ ] **登録フォーム**：モーダルまたは専用画面
- [ ] **事業者選択**：`clients`テーブルからのドロップダウン
- [ ] **担当者選択**：`staffs`テーブルからのドロップダウン
- [ ] **バリデーション**：必須項目チェック・日付整合性確認

#### 2.3 ワークフロー管理
```
依頼中 → 作業完了 → 確認完了 → アーカイブ
```
- [ ] **ステータス更新**：ボタンクリックでのステータス変更
- [ ] **タイムスタンプ自動記録**：`completed_at`・`confirmed_at`の自動設定
- [ ] **権限制御**：担当者のみ「作業完了」、依頼者のみ「確認完了」可能

### ステップ3: 表示機能拡張（所要時間: 4-5時間）

#### 3.1 多様なビュー実装
- [ ] **リスト表示**：テーブル形式（デフォルト）
- [ ] **カード表示**：Bootstrap Cards or CSS Grid
- [ ] **カレンダー表示**：FullCalendar.js導入
- [ ] **ガントチャート**：Chart.js Timeline plugin

#### 3.2 ドラッグ&ドロップ機能
- [ ] **SortableJS導入**：カード表示でのタスク並び替え
- [ ] **期限変更**：カレンダー・ガントチャートでの直感的編集
- [ ] **ステータス変更**：カンバンボードでのドラッグ移動

### ステップ4: 高度機能実装（所要時間: 4-5時間）

#### 4.1 テンプレート・ルーティン機能
- [ ] **テンプレート管理**：よく使うタスクの保存・呼出
- [ ] **ルーティン設定**：「毎月25日にA社月次記帳」等の自動生成ルール
- [ ] **Edge Functions実装**：Supabase Cron Jobでの定期実行

#### 4.2 ダッシュボード・分析機能
- [ ] **管理者ダッシュボード**：全体統計・負荷状況・遅延アラート
- [ ] **マイページ**：個人担当タスク・実績・統計
- [ ] **パフォーマンス分析**：担当者別効率・事業者別傾向

#### 4.3 通知システム
- [ ] **ブラウザ通知API**：タスク割当・期限接近・ステータス変更
- [ ] **アプリ内通知**：ベル・バッジでの視覚的通知
- [ ] **条件設定**：通知タイミング・対象の柔軟な設定

### ステップ5: 統合・最適化（所要時間: 2-3時間）

#### 5.1 既存アプリへの統合
- [ ] **ナビゲーションタブ追加**：analytics.html等の既存タブに「📋 タスク管理」を追加
- [ ] **管理メニュー拡張**：既存アコーディオンに「タスク管理設定」メニュー追加
- [ ] **既存スタイル活用**：style.css・custom-dropdown.css・toast.css等を完全継承

#### 5.2 パフォーマンス・UX最適化
- [ ] **遅延読み込み**：大量データ対応
- [ ] **キャッシュ戦略**：頻繁アクセスデータの効率化
- [ ] **モバイル最適化**：タッチ操作・レスポンシブUI

## 統合アプローチ特有の追加機能

### 既存機能との連携強化

#### 1. 進捗ダッシュボード統合
- **タスク完了率の可視化**：既存の進捗マトリクス表にタスク完了状況を追加表示
- **要注意クライアント検出**：タスク遅延も含めた総合的な要注意判定
- **週次グラフ拡張**：タスク処理数・遅延数の推移を既存グラフに統合

#### 2. 担当者パフォーマンス連携
- **タスク処理効率**：担当者別のタスク完了時間・品質指標を既存分析に追加
- **負荷バランシング**：月次進捗とタスク割当の最適化提案
- **総合評価システム**：既存の4段階評価にタスク処理能力を統合

#### 3. 統合分析機能
- **クライアント別分析**：月次進捗とタスク処理の相関関係分析
- **繁忙期予測**：過去のタスク発生パターンから業務負荷予測
- **効率化提案**：データ連携による具体的な改善アクション提示

### Phase 2実装候補（統合版）

#### 1. 高度連携機能
- **進捗連動タスク生成**：月次進捗の遅れを検知した自動タスク生成
- **スマート担当者提案**：既存のパフォーマンスデータに基づく最適担当者提案
- **統合レポート機能**：進捗とタスクを統合した包括的レポート生成

## 実装優先順位

### 【必須機能】- ステップ1-2
1. データベース構築・基本CRUD
2. ワークフロー管理（依頼→作業→確認）
3. 既存アプリとの認証・データ共有

### 【重要機能】- ステップ3
1. 多様な表示形式（リスト・カード・カレンダー）
2. フィルター・検索・ソート機能
3. 基本的な通知システム

### 【拡張機能】- ステップ4-5
1. テンプレート・ルーティン自動化
2. 高度な分析・ダッシュボード
3. インテリジェント機能

## 開発スケジュール

### 週次計画（総所要時間: 18-23時間）

#### Week 1: 基盤構築
- **Day 1-2**: ステップ1（環境設定・DB構築）
- **Day 3**: ステップ2.1（基本一覧・登録機能）

#### Week 2: コア機能
- **Day 1**: ステップ2.2-2.3（ワークフロー完成）
- **Day 2-3**: ステップ3.1（表示機能拡張）

#### Week 3: 高度機能・最適化
- **Day 1**: ステップ3.2（ドラッグ&ドロップ）
- **Day 2**: ステップ4（テンプレート・通知）
- **Day 3**: ステップ5（連携・最適化）

## セキュリティ・品質保証

### セキュリティ対策
- **RLS完全実装**：行レベルセキュリティによるデータ保護
- **XSS対策**：ユーザー入力の適切なサニタイズ
- **CSRF対策**：Supabase標準セキュリティの活用

### 品質保証
- **段階的テスト**：各ステップ完了時の動作確認
- **データ整合性チェック**：外部キー制約・バリデーション
- **パフォーマンステスト**：大量データでの動作検証

## メンテナンス性向上

### コード品質
- **既存スタイル準拠**：事業者管理アプリのコーディング規約継承
- **モジュール化**：機能別ファイル分割・再利用可能コンポーネント
- **適切なコメント**：複雑な処理への説明追加

### 拡張性確保
- **設定ファイル活用**：カスタマイズ可能な設定の外部化
- **API設計**：将来の機能拡張に対応した柔軟な構造
- **プラグイン対応**：追加機能の容易な組み込み

## 開発開始前の準備事項

### 1. 環境準備
- [ ] 既存プロジェクトのバックアップ作成
- [ ] 開発用ブランチ作成
- [ ] 必要なライブラリ・CDNの確認

### 2. 設計最終確認
- [ ] データベーススキーマの詳細レビュー
- [ ] UI/UXワイヤーフレームの確認
- [ ] 既存アプリとの連携仕様確定

### 3. 開発体制
- [ ] 段階的実装の詳細スケジュール確定
- [ ] テスト項目・品質基準の明確化
- [ ] エラー処理・ロールバック計画の策定

---

この計画書に基づいて段階的に実装を進めることで、安定性と拡張性を両立した高品質なタスク管理システムを構築できます。各ステップでの確実な動作確認により、リスクを最小化しながら効率的に開発を進めることが可能です。